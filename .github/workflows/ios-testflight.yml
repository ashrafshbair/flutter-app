name: Build & Upload Flutter iOS App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest

    env:
      APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Flutter (latest stable - supports Dart 3.10+)
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Clean project
      - name: Clean project
        run: flutter clean

      # Get dependencies
      - name: Install dependencies
        run: flutter pub get

      # Create App Store Connect API key file
      - name: Create API key file
        run: |
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > AuthKey.p8

      # Build IPA for App Store
      - name: Build iOS IPA
        run: flutter build ipa --export-method app-store

      # Upload IPA as artifact (downloadable)
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Runner.ipa
          path: build/ios/ipa/*.ipa

      # Upload to App Store Connect
      - name: Upload to App Store Connect
        run: |
          gem install fastlane
          fastlane pilot upload \
            --api_key_path AuthKey.p8 \
            --api_key_id $APP_STORE_CONNECT_KEY_ID \
            --issuer_id $APP_STORE_CONNECT_ISSUER_ID \
            --ipa build/ios/ipa/*.ipa
